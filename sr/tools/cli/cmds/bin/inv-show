#!/usr/bin/env python
from __future__ import print_function

import argparse
import pydoc
import subprocess

import sr.tools.inventory as srinv
from sr.tools.inventory import normalise_partcode
from sr.tools.inventory import oldinv

parser = argparse.ArgumentParser(
    description="Show the metadata of a given part, and its git history.")
parser.add_argument('partcode', type=str, help="The part code to look up.")
args = parser.parse_args()

top = oldinv.gettoplevel()
if top is None:
    print("Error: Must be run from within the inventory.", file=sys.stderr)
    exit(1)
inv = srinv.Inventory(top)

partcode = normalise_partcode(args.partcode)
part = inv.root.parts[partcode]

pager_text = "Full path: " + part.path
with open(part.info_path, 'r') as info_file:
    pager_text += info_file.read() + '\n'

pager_text += "Log\n===\n"
pager_text += subprocess.check_output(['git', '--no-pager', 'log', '--color',
                                      '--follow', '-C', '-M', part.path],
                                      universal_newlines=True)

pydoc.pager(pager_text)
