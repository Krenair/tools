#!/usr/bin/env python
# -*- coding: utf-8 -*-
from argparse import ArgumentParser
from decimal import Decimal as D
import sys
import sr.budget as budget
from sr.budget.diff import diff_trees, AddedItem, RemovedItem, ChangedItem

parser = ArgumentParser( description = "Diff two versions of the budget" )
parser.add_argument( "old",
                     help = "Old git commit to compare against." )
parser.add_argument( "new", nargs="?", default = "HEAD",
                     help = "New git commit to act as reference (default HEAD)." )
args = parser.parse_args()

# Build the two trees
a = budget.load_budget_rev( "./", args.old )
b = budget.load_budget_rev( "./", args.new )

changes = diff_trees( a, b )

class Summary:
    def __init__(self):
        self.added = D(0)
        self.removed = D(0)

summary = Summary()

for x in changes:

    if isinstance(x, AddedItem):
        print "A", x.a.name, "({0})".format(x.a.cost)
        summary.added += x.a.cost

    if isinstance(x, RemovedItem):
        print "D", x.a.name, "({0})".format(x.a.cost)
        summary.removed += x.a.cost

    if isinstance(x, ChangedItem):
        d = x.b.cost - x.a.cost

        s = ""
        if d > 0:
            s = "+"
            summary.added += d
        else:
            summary.removed += -d

        print "M", x.a.name, "({0}{1})".format( s,d )

print "---"
print " Summary"
print "      Added: £{0}".format(summary.added)
print "    Removed: £{0}".format(summary.removed)
print " Net change: {0:+}".format(summary.added - summary.removed)
