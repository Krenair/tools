#!/usr/bin/env python
import argparse
from sr.trac import TracProxy, WrongServer
from sr.trac.deptree import Ticket
import sys

parser = argparse.ArgumentParser( description = "Add dependencies to a ticket" )
parser.add_argument( "ticket", type = int,
                     help = "Ticket number" )
parser.add_argument( "deps", type = int, nargs = "+",
                     help = "Tickets to add" )
parser.add_argument( "-m", type = str,
                     help = "Message to append" )
parser.add_argument( "--dry-run", action = "store_true",
                     help = "Go through the motions, but don't commit the change" )
args = parser.parse_args()

try:
    server = TracProxy()
except WrongServer:
    print >>sys.stderr, "Error: The specified server is not a Trac instance"
    exit(1)

t = Ticket( args.ticket, server )

for n in args.deps:
    if n in t.deps:
        print >>sys.stderr, "#{0} is already a dep of #{1}".format( n, args.ticket )
        exit(1)
    t.deps += args.deps

if args.m is not None:
    msg = args.m
    msg += "\n\n"
else:
    msg = ""

msg += "Adding dependencies:"
for n in args.deps:
    msg += "\n * #{0}".format( n )

updated = t.cleanup( dry_run = args.dry_run,
                     msg = msg )

if updated:
    if args.dry_run:
        print "Ticket would have been updated if not for --dry-run."
    else:
        print "Ticket updated."
