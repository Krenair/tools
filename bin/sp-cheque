#!/usr/bin/env python
from argparse import ArgumentParser
import getpass
import os
from sr import spending
import sys
import xmlrpclib

_SERVER = "www.studentrobotics.org"
_PORT = 443

parser = ArgumentParser( description = "Add a cheque to a purchase" )
parser.add_argument("CHEQUE", type=int, help="Cheque number")
parser.add_argument("TRAC", type=int, help="Trac ticket number")
args = parser.parse_args()

try:
    root = spending.find_root()
except spending.NotSpendingRepo:
    print >>sys.stderr, "Please run in spending.git top level directory"
    exit(1)

spends =  spending.load_transactions('.')
for spend in spends:
    if spend.trac == args.TRAC:
        print "Updating " + spend.fname
        spendfile = open(spend.fname,'r+')
        for line in spendfile.readlines():
            if line.startswith("trac"):
                spendfile.write( "cheque: {0}\n".format( args.CHEQUE ) )
            if line.startswith("cheque"):
                print "ERROR: This file already has a cheque attribute"
                quit()
        spendfile.close()

rpc_url = "https://{username}:{password}@{server}:{port}/trac/login/rpc".format( 
    username = raw_input( "Username: " ),
    password = getpass.getpass(),
    server = _SERVER,
    port = _PORT )

server = xmlrpclib.ServerProxy( rpc_url )

server.ticket.update( args.TRAC,
                      "Paid.  Cheque: {0}".format( args.CHEQUE ),
                      { 'status': 'closed',
                        'resolution': 'fixed' } )
