#!/usr/bin/env python
from argparse import ArgumentParser
from sr import spending
from sr.trac import TracProxy
import sys

parser = ArgumentParser( description = "Add a cheque to a purchase" )
parser.add_argument("CHEQUE", type=int, help="Cheque number")
parser.add_argument("TRAC", type=int, help="Trac ticket number")
args = parser.parse_args()

try:
    root = spending.find_root()
except spending.NotSpendingRepo:
    print >>sys.stderr, "Please run in spending.git top level directory"
    exit(1)

spends =  spending.load_transactions('.')
for spend in spends:
    if spend.trac == args.TRAC:
        print "Updating " + spend.fname

        with open(spend.fname, "r+") as spendfile:
            for line in spendfile.readlines():
                if line.startswith("trac"):
                    spendfile.write( "cheque: {0}\n".format( args.CHEQUE ) )
                if line.startswith("cheque"):
                    print "ERROR: This file already has a cheque attribute"
                    quit()

server = TracProxy()

server.ticket.update( args.TRAC,
                      "Paid.  Cheque: {0}".format( args.CHEQUE ),
                      { 'status': 'closed',
                        'resolution': 'fixed' } )
