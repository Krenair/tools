#!/usr/bin/env python
from sr import spending
import xmlrpclib, argparse, getpass, yaml, os, sys

_SERVER = "www.studentrobotics.org"
_PORT = 443
if not (os.path.exists('.git') and os.path.exists('spending.py')):
    print >>sys.stderr, "Please run in spending.git top level directory"
    exit(1)

parser = argparse .ArgumentParser("Add a cheque to a purchase")
parser.add_argument("CHEQUE", help="Cheque number")
parser.add_argument("TRAC", type=int, help="Trac ticket number")

args = parser.parse_args()

spends =  spending.load_transactions('.')
for spend in spends:
    if spend.trac == args.TRAC:
        print "Updating " + spend.fname
        spendfile = open(spend.fname,'r+')
        for line in spendfile.readlines():
            if line.startswith("trac"):
                spendfile.write("cheque: " + str(args.CHEQUE) + "\n")
            if line.startswith("cheque"):
                print "ERROR: This file already has a cheque attribute"
                quit()
        spendfile.close()

rpc_url = "https://{username}:{password}@{server}:{port}/trac/login/rpc".format( 
    username = raw_input( "Username: " ),
    password = getpass.getpass(),
    server = _SERVER,
    port = _PORT )

server = xmlrpclib.ServerProxy( rpc_url )

server.ticket.update(int(args.TRAC),"Paid, cheque " + args.CHEQUE,{'status': 'closed', 'resolution': 'fixed'})
