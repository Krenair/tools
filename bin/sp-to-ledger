#!/usr/bin/env python
# coding=utf8
from decimal import Decimal as D
from sr import spending
import sys

try:
    from chequelut import lut
except ImportError:
    # The cheque lut isn't present
    # (it's confidential at the moment)
    lut = {}

# Times we received funds from Motorola
# TODO: Dates are not exactly correct
print """

2011/11/15 Initial Bank Balance
	Assets:Barclays		£2130.12
	Equity:Opening Balance

2012/04/01 Motorola Funding
	Assets:Barclays		£34662.51
	Income:Motorola Solutions Foundation

2013/02/01 Motorola Funding
	Assets:Barclays		£31281.36
	Income:Motorola Solutions Foundation
"""

class Cheque:
    def __init__(self):
        self.cost = D(0)
        self.date = None
        self.recip = None

cheques = {}

for txn in spending.load_transactions('.'):

    if txn.date is None:
        "This is a pending transaction"
        recip = txn.payee
        txdate = txn.ackdate
        src = "Liabilities:{0}".format( recip )

    elif txn.cheque is not None:
        "This is not a pending txn, and it has been paid by cheque"
        if txn.cheque not in cheques:
            cheques[txn.cheque] = Cheque()

        cheque = cheques[txn.cheque]
        cheque.cost += txn.cost
        cheque.date = txn.date

        # Work out who paid who
        if txn.cheque not in lut:
            cheque.recip = "unknown"
        else:
            cheque.recip = lut[txn.cheque]

        txdate = txn.date
        src = "Liabilities:{0}".format( cheque.recip )

    elif txn.bank_transfer:
        src = "Assets:Barclays"
        txdate = txn.date

    if txn.payee is not None:
        summary = "{0}\t;{1}".format( txn.payee,
                                      txn.summary )
    else:
        summary = txn.summary

    f = u"""{date} {summary}
	Expenses:{budgetline}	£{cost}
	{src}
	; trac: #{trac}
	; name: {name}
"""

    f = f.format(
        date = txdate.strftime( "%Y/%m/%d" ),
        summary = summary,
        name = txn.name,
        cost = txn.cost,
        trac = txn.trac,
        budgetline = txn.budget.replace( "/", ":" ),
        src = src )

    print f.encode("utf-8")
    print

for num, cheque in cheques.iteritems():
    if num is None:
        print >>sys.stderr, "Error: Item with no cheque number"
        exit(0)

    print """{date} Cheque {num}
	Liabilities:{recip}	£{cost}
	Assets:Barclays
	; cheque: {num}""".format(
            date = cheque.date.strftime( "%Y/%m/%d" ),
            num = num,
            recip = cheque.recip,
            cost = cheque.cost )
    print

# Known bank balances:
#  2014/02/13: £7925.33
